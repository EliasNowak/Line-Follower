#include <avr/io.h>
#include <stddef.h>
#include <uart.h>

// function pointer to the function to be called once data are received
void (*pReceptionCallback)(uint8_t data) = NULL;

void uart0_registerReceptionCallback(void (*pCallback)(uint8_t data))
{
    uart0_init(9600, UART_M_TRANSCEIVE, UART_P_NONE);
    pReceptionCallback = pCallback; // remember the function to be called

    if (pCallback != NULL)
    {
        UCSR0B |= (1 << RXCIE0); // enable reception interrupt
    }
    else
    {
        UCSR0B &= ~(1 << RXCIE0); // disable reception interrupt
    }
}

// the interrupt routine is called whenever data are received
ISR(USART0_RX_vect)
{
    uart0_putc(UDR0);
    // check if the function pointer points to a valid function
    if (pReceptionCallback != NULL)
    {
        (*pReceptionCallback)(UDR0);
    }
}
